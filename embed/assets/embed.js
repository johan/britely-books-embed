(function(){var _base,_base1,_base2,_base3,_base4,_base5,_ref,_ref1,_ref2,_ref3,_ref4,_ref5,_ref6,_ref7,_ref8,_ref9,__hasProp={}.hasOwnProperty;if((_ref=Object.create)==null){Object.create=function(proto){var Classy;if(arguments.length!==1){throw new Error("Can't simulate Object.create property descriptors")}Classy=(function(){function Classy(){}return Classy})();Classy.prototype=proto;return new Classy}}if((_ref1=Object.keys)==null){Object.keys=function(object){var name,_results;_results=[];for(name in object){if(!__hasProp.call(object,name)){continue}_results.push(name)}return _results}}if((_ref2=Object.values)==null){Object.values=function(object){var k,val,_results;_results=[];for(k in foo){if(!__hasProp.call(foo,k)){continue}val=foo[k];_results.push(val)}return _results}}if((_ref3=(_base=String.prototype).trim)==null){_base.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}if((_ref4=Date.now)==null){Date.now=function(){return(new Date).getTime()}}if((_ref5=(_base1=Function.prototype).bind)==null){_base1.bind=function(self){var bound,first,func;func=this;first=arguments.slice(1);bound=function(){var args;args=first.concat(arguments.slice(0));if(!(this instanceof bound)){return func.apply(self,args)}func.apply(this,args);return void 0};bound.prototype=func.prototype;return bound}}if((_ref6=(_base2=Array.prototype).indexOf)==null){_base2.indexOf=function(x){var i,l;i=0;l=this.length;while(i<l){if(x===this[i]){return i}i++}return -1}}if((_ref7=(_base3=Array.prototype).filter)==null){_base3.filter=function(fn,self){var i,l,res,val;if(typeof fn!=="function"){throw new TypeError(fn+" is not a function")}i=0;l=this.length;res=[];while(i<l){if(i in this){val=this[i];if(fn.call(self,val,i,this)){res.push(val)}}i++}return res}}if((_ref8=(_base4=Array.prototype).forEach)==null){_base4.forEach=function(fn,self){var i,l;if(typeof fn!=="function"){throw new TypeError(fn+" is not a function")}i=0;l=this.length;while(i<l){if(i in this){fn.call(self,this[i],i,this)}i++}return void 0}}if((_ref9=(_base5=Array.prototype).map)==null){_base5.map=function(fn,self){var i,l,res;if(typeof fn!=="function"){throw new TypeError(fn+" is not a function")}i=0;l=this.length;res=[];while(i<l){if(i in this){res[i]=fn.call(self,this[i],i,this)}i++}return res}}}).call(this);(function(){var d3_timer_flush,d3_timer_frame,d3_timer_interval,d3_timer_queue,d3_timer_step,d3_timer_timeout;d3_timer_queue=null;d3_timer_interval=null;d3_timer_timeout=null;d3_timer_frame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return setTimeout(callback,17)};d3_timer_step=function(){var delay,elapsed,now,t1;now=Date.now();t1=d3_timer_queue;while(t1){elapsed=now-t1.then;if(elapsed>=t1.delay){t1.flush=t1.callback(elapsed)}t1=t1.next}delay=d3_timer_flush()-now;if(delay>24){if(isFinite(delay)){clearTimeout(d3_timer_timeout);d3_timer_timeout=setTimeout(d3_timer_step,delay)}return d3_timer_interval=0}else{d3_timer_interval=1;return d3_timer_frame(d3_timer_step)}};d3_timer_flush=function(){var t0,t1,then_;t1=d3_timer_queue;then_=Infinity;while(t1){if(t1.flush){t1=t0?t0.next=t1.next:d3_timer_queue=t1.next}else{then_=Math.min(then_,t1.then+t1.delay);t0=t1;t1=t1.next}}return then_};window.timer=function(callback,delay,then_){var found,t0,t1;if(delay==null){delay=0}if(then_==null){then_=Date.now()}found=false;t1=d3_timer_queue;if(!isFinite(delay)){return}while(t1){if(t1.callback===callback){t1.then=then_;t1.delay=delay;found=true;break}t0=t1;t1=t1.next}if(!found){d3_timer_queue={callback:callback,then:then_,delay:delay,next:d3_timer_queue}}if(!d3_timer_interval){d3_timer_timeout=clearTimeout(d3_timer_timeout);d3_timer_interval=1;return d3_timer_frame(d3_timer_step)}};window.timer.flush=function(){var elapsed,now,t1;now=Date.now();t1=d3_timer_queue;while(t1){elapsed=now-t1.then;if(!t1.delay){t1.flush=t1.callback(elapsed)}t1=t1.next}return d3_timer_flush()}}).call(this);function pageflipper(page_no){var PAGE=page_no,callbacks=[],FLIPPING=false,PAGE_FLIP_MS=1000,$book=$(".main-book"),pages=$book.find("section.book-page").get(),flips=[],i,len,side,page,past,lhash,$page,$back;for(i=0,len=pages.length;page=pages[i];i++){$page=$(page).css("z-index",len-i);$back=(i<len-1)?$page.after('<div class="book-page back"></div>').next().css({"z-index":len-i,width:0}):$();if(!Modernizr.cssgradients){$back.append('<div class="back-gradient"></div>')}past=PAGE>i;if(past){$page.width(0);side=-1}else{side=1}flips.push({progress:side,source:-side,target:side,$back:$back,done:true,page:pages[i],started:+new Date})}function togglePage(n,on_off){return $("#book-page-"+(n+1)).toggleClass("undisplayed",!on_off)}function prevPage(e){startAnimation();togglePage(--PAGE,true);var flip=flips[PAGE];flip.done=false;flip.source=-1;flip.target=1;flip.started=+new Date}function nextPage(e){startAnimation();var flip=flips[PAGE];flip.done=false;flip.source=1;flip.target=-1;flip.started=+new Date;togglePage(++PAGE,true).css("width",$globals.PAGE_WIDTH*($globals.SCALE||1))}function gotoPage(to_page){while(PAGE<to_page){nextPage()}while(PAGE>to_page){prevPage()}}function easeOutCubic(time,start,delta,duration){return start+delta*(Math.pow(time/(duration||1)-1,3)+1)}function render(){var i,len,flip,dt,t=+new Date,drawn=[];for(i=0,len=flips.length;flip=flips[i];i++){if(flip.done){continue}drawn.push(flip);if(flip.started==t){continue}dt=Math.min(PAGE_FLIP_MS,t-flip.started)/PAGE_FLIP_MS;flip.progress=easeOutCubic(dt,flip.source,flip.target-flip.source);if(flip.progress>=0.997){flip.$back.hide();flip.done=true;flip.progress=1;togglePage(i+1,false).width($globals.PAGE_WIDTH*($globals.SCALE||1))}else{if(flip.progress<=-0.997){flip.$back.hide();flip.done=true;flip.progress=-1;togglePage(i,false).width($globals.PAGE_WIDTH*($globals.SCALE||1))}}}if(drawn.length){drawn.forEach(drawFlip)}else{FLIPPING=false;if(callbacks.length){setTimeout(fireCallbacks,0)}}return !FLIPPING}function startAnimation(){if(FLIPPING){return}FLIPPING=true;timer(render)}function drawFlip(flip){var foldWidth=Math.round($globals.PAGE_WIDTH*($globals.SCALE||1)/2*(1-flip.progress)),x1=Math.round($globals.PAGE_WIDTH*($globals.SCALE||1)*flip.progress),foldX=Math.max(x1,0);$(flip.page).width(foldX);flip.$back.css({left:x1+"px",width:foldWidth+"px"}).show()}function postpone(cb){return callbacks.push(cb)}function fireCallbacks(){callbacks.forEach(function(cb){cb()});callbacks=[]}return{nextPage:pageflipper.nextPage=nextPage,prevPage:pageflipper.prevPage=prevPage,gotoPage:pageflipper.gotoPage=gotoPage,postpone:pageflipper.postpone=postpone}}if(!Modernizr.touch){jQuery.event.special.clickOrTap={add:function(o){$(this).bind("click.jqtap",o.data,o.handler)},remove:function(o){return $(this).unbind("click.jqtap")}}}else{(function($){var $elems=$([]),tapStart,tapElem;$.tapThreshold=Infinity;$.event.special.clickOrTap={add:function(handleObj){$(this).bind("tap.jqtap",handleObj.data,handleObj.handler).bind("click.jqtap",noClick)},remove:function(handleObj){$(this).unbind("tap.jqtap").unbind("click.jqtap")}};$.event.special.tap={setup:function(d,ns,fn){$elems=$elems.add(this);if(1===$elems.length){$(document).bind("touchstart.jqtap",touchStart).bind("touchend.jqtap",touchEnd)}},teardown:function(){$elems=$elems.not(this);if(0===$elems.length){$(document).unbind(".jqtap")}}};function noClick(e){e.preventDefault()}function touchStart(e){if(e.originalEvent.touches.length>1){tapStart=tapElem=undefined}else{tapStart=e.timeStamp;tapElem=e.target}}function touchEnd(e){if((e.timeStamp-tapStart>$.tapThreshold)||(e.originalEvent.touches.length>1)||(tapElem!==e.target)){tapStart=tapElem=undefined}else{if($elems.is(tapElem)||$elems.find(tapElem).length){e.preventDefault();e.stopPropagation();var $e=$(tapElem);$e.add($e.parents()).filter($elems).triggerHandler("tap")}}}})(jQuery)}jQuery.fn.clickOrTap=function(){var $this=$(this),args=[].slice.call(arguments,0);return $this.bind.apply($this,["clickOrTap.jqtap"].concat(args))};
/*!
 * jQuery Cookie Plugin
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
(function($){$.cookie=function(key,value,options){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(value))||value===null||value===undefined)){options=$.extend({},options);if(value===null||value===undefined){options.expires=-1}if(typeof options.expires==="number"){var days=options.expires,t=options.expires=new Date();t.setDate(t.getDate()+days)}value=String(value);return(document.cookie=[encodeURIComponent(key),"=",options.raw?value:encodeURIComponent(value),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join(""))}options=value||{};var decode=options.raw?function(s){return s}:decodeURIComponent;var pairs=document.cookie.split("; ");for(var i=0,pair;pair=pairs[i]&&pairs[i].split("=");i++){if(decode(pair[0])===key){return decode(pair[1]||"")}}return null}})(jQuery);(function(){var $,flash;$=jQuery;flash=null;$.cookieFlash=function(opts){var name,path,read,set,_ref,_ref1,_ref2,_ref3;if(opts==null){opts={}}name=(_ref=(_ref1=opts.cookie)!=null?_ref1.name:void 0)!=null?_ref:"flash";path=(_ref2=(_ref3=opts.cookie)!=null?_ref3.path:void 0)!=null?_ref2:"/";read=function(){try{return JSON.parse($.cookie(name)||"{}")}catch(e){return{}}};set=function(bits){var res;res=$.extend(read(),bits);$.cookie(name,JSON.stringify(res),{path:path});return res};if(!flash){flash=read();$.cookie(name,null,{path:path})}return{vars:flash,set:set}}}).call(this);(function(){var $,browserPrefixes,cancelFullScreen,isFullScreen,noop,prefix,supportsFullScreen,_i,_len,__slice=[].slice;$=jQuery;isFullScreen=function(){switch(prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[prefix+"FullScreen"]}};cancelFullScreen=function(el){if(prefix===""){return document.cancelFullScreen()}else{return document[prefix+"CancelFullScreen"]()}};supportsFullScreen=document.cancelFullScreen!=null;browserPrefixes=["webkit","moz","o","ms","khtml"];noop=function(){};if(!supportsFullScreen){for(_i=0,_len=browserPrefixes.length;_i<_len;_i++){prefix=browserPrefixes[_i];if(document[prefix+"CancelFullScreen"]!=null){supportsFullScreen=true;break}}}if(supportsFullScreen){$.fn.requestFullScreen=function(){return this.each(function(){if(prefix===""){return this.requestFullScreen()}else{return this[prefix+"RequestFullScreen"]()}})};$.fn.fullScreenChange=function(){var args,_ref;args=1<=arguments.length?__slice.call(arguments,0):[];return(_ref=$(this)).bind.apply(_ref,[prefix+"fullscreenchange"].concat(args))};$.FullScreen={isFullScreen:isFullScreen,cancelFullScreen:cancelFullScreen}}else{$.fn.requestFullScreen=$.fn.fullScreenChange=noop;$.FullScreen={isFullScreen:function(){return false},cancelFullScreen:noop}}}).call(this);(function(){var $,IS_IOS;$=jQuery;IS_IOS=/iphone|ipad/i.test(navigator.userAgent);$.fn.nodoubletapzoom=function(){if(IS_IOS){$(this).bind("touchstart",function(e){var $this,dt,t2;$this=$(this);t2=e.timeStamp;dt=t2-($this.data("lastTouch")||t2);$this.data("lastTouch",t2);if(e.originalEvent.touches.length<2&&dt&&dt<=500){e.preventDefault();return $this.trigger("click")}})}return this}}).call(this);(function(){var later,localDelete,localGet,localSet,param;window.localDelete=function(k){return $.cookie(k,null,{path:"/"})};window.localSet=function(k,v){return $.cookie(k,JSON.stringify(v),{path:"/"})};window.localGet=function(k,v){var c;c=$.cookie(k);if(c){return JSON.parse(c)}else{return v}};window.KM_DEBUG=/KM/.test(location.hash);window.GA_DEBUG=/GA/.test(location.hash);if(Modernizr.localstorage){localDelete=function(k){return localStorage.removeItem(k)};localSet=function(k,v){return localStorage.setItem(k,JSON.stringify(v))};localGet=function(k,v){var s;s=localStorage.getItem(k);if(s){return JSON.parse(s)}else{return v}}}param=function(obj){return $.param(obj).replace(/\+/g,"%20")};window.trackKMEvent=function(category,props){var ev,prop,src,src_vals,val,_ref,_ref1;if(props==null){props={}}if(typeof viewmode!=="undefined"&&viewmode!==null){if((_ref=props.viewmode)==null){props.viewmode=viewmode}}ev=["record",category];src=$.cookieFlash().vars.book_source;if(src){src_vals=src.split("-");if(src_vals.length>0){props["book source"]=src_vals[0]}if(src_vals.length>1){props["book tile position"]=src_vals[1]}}if(window.$ml){$.extend(props,$ml.virality_info)}for(prop in props){val=props[prop];if(!(val!=null)){delete props[prop]}}ev.push(props);if(KM_DEBUG&&((_ref1=window.console)!=null?_ref1.log:void 0)){console.log("KM event "+category,Object.keys(props).length?$.extend({},props):"")}return _kmq.push(ev)};window.trackGAEvent=function(category,action,label,value){var _ref;if("object"===typeof action&&(action!=null)){action=param(action)}if("object"===typeof label&&(label!=null)){label=param(label)}if(GA_DEBUG&&((_ref=window.console)!=null?_ref.log:void 0)){console.log("GA event "+category+"/"+action+" "+(label?", label:"+label(+", value:"+value):""))}if(typeof value!=="number"){value=1}return _gaq.push(["_trackEvent",category,action,label,value])};window.trackGAKM=function(category,action,events){var label,_i,_len,_results;trackKMEvent(action,events);if(!events){return trackGAEvent(category,action)}else{_results=[];for(_i=0,_len=events.length;_i<_len;_i++){label=events[_i];if(typeof events[label]==="number"){trackGAEvent(category,action,label,events[label])}else{if(events[label]!==null){trackGAEvent(category,action,events[label],1)}else{trackGAEvent(category,action,label,1)}}break}return _results}};window.trackLater=function(category,action,events){var name;name="track_later";return localSet(name,localGet(name,[]).concat([[category,action,events]]))};window.trackGALater=function(category,action,label,value){var name;name="track_GA_later";return localSet(name,localGet(name,[]).concat([[category,action,label,value]]))};window.trackKMLater=function(action,events){var name;name="track_KM_later";return localSet(name,localGet(name,[]).concat([[action,events]]))};later=function(id,fn){var act;act=function(args){return fn.apply(this,args)};if((localGet(id,[]).map(act).length)){return localDelete(id)}};later("track_later",trackGAKM);later("track_GA_later",trackGAEvent);later("track_KM_later",trackKMEvent);window.trackGAPageview=function(path,details,callback){var url,x,_i,_len,_ref;url=/^\//.test(path)?path:"/"+path;if(details){for(_i=0,_len=details.length;_i<_len;_i++){x=details[_i];if(null===details[x]){delete details[x]}url+=(/\?/.test(path)?"&":"?")+param(details)}}_gaq.push(["_trackPageview",url]);if(GA_DEBUG&&((_ref=window.console)!=null?_ref.log:void 0)){console.log("GA pageview "+url)}if(typeof callback==="function"){if(dev_mode){return setTimeout(callback,0)}else{return _gaq.push(callback)}}};window.trackGAPage=function(name,details,callback){return trackGAPageview("/ga/"+name,details,callback)}}).call(this);var started=false,finished=false,win=window,page=0,viewmode="embed-inline",MESSAGE="#message"===location.hash,fin_page,bare,flipper,$html,$pages,$iframe,$expand,$globals,BOOK_URL,BOOK_USER,BOOK_PATH,BOOK_TITLE,WEB_HOST=window.location.hostname.replace(/^cache\.britely\.com$/,"books.britely.com");$(document).ready(function(){$globals={PAGE_WIDTH:Number($(".book-page > img").attr("width"))};BOOK_TITLE=$("title").text();BOOK_USER=$(".attribution .book .whom").attr("data-author");BOOK_PATH=(BOOK_URL=$("link[rel=canonical]").attr("href")).replace(/^(http:)?\/\/[^\/]*/,"");fin_page=$(".book-page").length-1;bare=$("html").hasClass("bare");flipper=pageflipper(page);$html=$("html");$iframe=$("iframe");$expand=$(".expand");if(bare){win.trackGAKM=win.trackGAEvent=win.trackKMEvent=win.trackLater=function(){}}trackKMEvent("Embed impression",{book:BOOK_PATH,book_user:BOOK_USER});$(window).bind("message.log",function trackFirstEmbedHover(e){if('{"embed":"mouseover"}'!==e.originalEvent.data){return}$(window).unbind("message.log");trackGAKM("Reading","Hover over embed",{book:BOOK_PATH,viewmode:viewmode})});$(window).bind("message.scripted",function flip(e){switch(e.originalEvent.data){case'{"action":"prevPage"}':prevPage(e);break;case'{"action":"nextPage"}':nextPage(e);break}});$(".logo").click(function(){trackLater("Reading","Logo clicked",{book:BOOK_PATH,viewmode:viewmode})});$(".transparent").nodoubletapzoom();$(".prev").clickOrTap(prevPage);$(".next").clickOrTap(nextPage);$(document).keydown(function(e){if($(e.target).is("input,textarea")){return}var fn={37:prevPage,39:nextPage}[e.keyCode];if(fn){fn(e)}});$expand.clickOrTap(enterFullScreen);$iframe.fullScreenChange(maybeHideReadMode);$iframe.bind({"exit-fullscreen":leaveFullScreen,"prev-page":prevPage,"next-page":nextPage})});function enterFullScreen(e){function show(){$iframe.css("visibility","visible");frames[0].focus()}var url=$iframe.data("src"),arg=$iframe.data("arg"),now=$iframe.prop("src");if(now){show()}else{$iframe.attr("src",url+(1+page)+arg);$iframe.load(show)}$iframe.requestFullScreen();e.preventDefault()}function maybeHideReadMode(){if(!$.FullScreen.isFullScreen()){$iframe.css("visibility","hidden");window.focus()}}function leaveFullScreen(e){$.FullScreen.cancelFullScreen()}function messageChildFrame(message){var win=$iframe.get(0).contentWindow;if(win&&win.postMessage){win.postMessage('{"type":"'+message+'"}',"*")}}function messageParentWindow(message){function string(s){return'"'+(s.replace(/\\/g,"\\\\").replace(/"/g,'\\"'))+'"'}var win=window.parent,json="",key,val;if(win&&win.postMessage){for(key in message){val=message[key];json+=(json?",":"{")+'"'+key+'":'+("string"===typeof val?string(val):"number"===typeof val?val:"null")}json+="}";win.postMessage(json,"*")}}function prevPage(e){var message="prev-page",dont_log=e.type===message;loadImgsIfNot(e);if(page>0){flipper.prevPage();page--;turnedPage("prev",page+1,dont_log)}if(!dont_log){messageChildFrame(message)}$html.toggleClass("first-page",!page).removeClass("last-page")}function nextPage(e){var message="next-page",dont_log=e.type===message;loadImgsIfNot(e);if(page<fin_page){flipper.nextPage();page++;turnedPage("next",page+1,dont_log);if(!dont_log){messageChildFrame(message)}}$html.toggleClass("first-page",!page).toggleClass("last-page",page==fin_page);if(dont_log){return}if(!started){started=true;trackKMEvent("Opened Book",{book:BOOK_PATH,viewmode:viewmode});trackGAEvent("Reading","Opened Book",BOOK_TITLE);$.get("http://"+WEB_HOST+BOOK_PATH+"/"+page+"/view",{opened_book:1,first_open:1})}if(!finished&&page==fin_page){finished=true;trackGAKM("Reading","Finished Reading",{book:BOOK_PATH,viewmode:viewmode})}}function turnedPage(dir,to_page,dont_log){var $page=$("#book-page-"+to_page),owner=$page.data("owner"),a_url=$page.data("attribution_url"),$via=$(".photo"),$iatt=$via.find(".by");$via.toggle(!!owner);$iatt.attr("title",owner).text(owner);if(a_url){$iatt.attr("href",a_url)}else{$iatt.removeAttr("href")}if(dont_log){return}trackGAEvent("Reading","Turned Page",BOOK_TITLE,to_page);trackKMEvent("Turned Page",{viewmode:viewmode,book:BOOK_PATH,to_page:to_page,dir:dir});if(MESSAGE){messageParentWindow({brite:BOOK_URL,title:BOOK_TITLE,author:BOOK_USER,photo_by:owner,photo_url:a_url,page:to_page,id:location.pathname.split("/").pop()})}}function loadImgsIfNot(e){e.preventDefault();$(".book-page > img[data-src]").each(function(){var $this=$(this);$this.attr("src",$this.data("src"));this.removeAttribute("data-src")})};